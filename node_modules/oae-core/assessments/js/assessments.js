/*!
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'oae.core'], function($, oae) {

    return function(uid, showSettings) {

        // The widget container
        var $rootel = $('#' + uid);

        // Caches the content profile data
        var contentProfile = null;

        // Caches the assessments information
        var assessments = null;

// STUBBED: simulate API call
        var authNeeded = true;

        /**
         * Get the latest assessments data and update modal
         */
        var getAssessmentsData = function() {
// STUBBED: API call should be here
            assessments = {
                status: 'Not submitted for assessment',
                assessors: [
                    {
                        label: 'CS 6210, Advanced Operating Systems',
                        assignments: [
                            {label: "Assignment 1: Due Today"},
                            {label: "Assignment 2: Due Next Week"}
                        ]
                    },
                    {
                        label: 'CS 6250, Computer Networks',
                        assignments: [
                            {label: "Assignment 3: Due Today"},
                            {label: "Assignment 4: Due Next Week"}
                        ]
                    },
                    {
                        label: 'CS 6300, Software Development Process',
                        assignments: [
                            {label: "Assignment 5: Due Today"},
                            {label: "Assignment 6: Due Next Week"}
                        ]
                    },
                    {
                        label: 'CS 7641, Machine Learning',
                        assignments: [
                            {label: "Assignment 7: Due Today"},
                            {label: "Assignment 8: Due Next Week"}
                        ]
                    },
                    {
                        label: 'CS 8802, Artificial Intelligence for Robotics',
                        assignments: [
                            {label: "Assignment 9: Due Today"},
                            {label: "Assignment 10: Due Next Week"}
                        ]
                    }
                ]
            };

            $('#assessments-status', $rootel).text(assessments.status);
            oae.api.util.template().render(
                $('#assessments-assessor-template', $rootel),
                { 'assessors': assessments.assessors },
                $('#assessments-assessors', $rootel)
            );
        };

        /**
         * Redirect to site for granting authorization
         */
        var grantAuthorization = function() {

// STUBBED: Redirect to authorization site
            authNeeded = false;

            $('#assessments-auth-modal', $rootel).modal('hide');
        }

        /**
         * Submit content for assessment
         */
        var submitAssessment = function() {
            var assessor = assessments.assessors[$('input[name="assessors"]:checked', $rootel).val()];

// STUBBED: API call should be here
            var err = false;

            var notificationTitle = oae.api.util.template().render($('#assessments-notification-title-template', $rootel), {
                err: err
            });
            var notificationBody = oae.api.util.template().render($('#assessments-notification-body-template', $rootel), {
                err: err,
                assessor: assessor,
                contentProfile: contentProfile
            });
            oae.api.util.notification(notificationTitle, notificationBody, err ? 'error' : 'success');

            if (!err) {
                $('#assessments-modal', $rootel).modal('hide');
            }
        };

        /**
         * Initializes the assessments modal dialog
         */
        var setUpAssessmentsModal = function() {
            // Catch the revision modal trigger
            $(document).on('click', '.oae-trigger-assessments', function() {

// STUBBED: API call should be here to set authNeeded

                // We may need to request authorization before showing the full widget
                if (authNeeded) {
                    $('#assessments-auth-modal', $rootel).modal();

                // No auth needed, so go right to the full widget
                } else {
                    $('#assessments-modal', $rootel).modal();
                }
            });

            // Request the current page context when the modal is showing
            $('#assessments-modal', $rootel).on('shown', function () {
                $(document).trigger('oae.context.get', 'assessments');
            });

            // Catch the send context event, cache the content profile and retrieve assessment info
            $(document).on('oae.context.send.assessments', function(ev, data) {
                contentProfile = data;
                getAssessmentsData();
            });
        };

        /**
         * Binds actions to various elements in the assessments widget
         */
        var addBindings = function() {

            // Show assigments when assessor selected
            $rootel.on('click', '#assessments-assessors input[type="radio"].assessor', function() {
                var $assignments = $(this).siblings(".assessments-assignments");

                // Temporarily change to auto and get the height
                var curHeight = $assignments.height();
                var autoHeight = $assignments.css('height', 'auto').height();

                // Restore to previous height and animate to auto
                $assignments.height(curHeight).animate({ height: autoHeight }, 400, function() {
                   $assignments.css('height', 'auto').addClass("active");
                });

                // Also hide assignments for other assessors
                $(".assessments-assignments.active", $rootel).not($assignments).animate({height: 0}, function() {
                   $(".assessments-assignments.active", $rootel).not($assignments).css('height', '0').removeClass("active");
                })

                // If no assignment has been selected, disable submission
                $('#assessments-submit', $rootel).prop('disabled', $assignments.find("input:checked").length === 0);
            });

            // Enable submit when assignment selected
            $rootel.on('click', '#assessments-assessors input[type="radio"].assignment', function() {
                $('#assessments-submit', $rootel).prop('disabled', false);
            });

            // Allow authorization
            $rootel.on('click', '#assessments-auth-continue', grantAuthorization);

            // Submit for assessment
            $rootel.on('click', '#assessments-submit', submitAssessment);
        };

        setUpAssessmentsModal();
        addBindings();

    };
});
