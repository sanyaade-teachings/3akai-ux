/*!
 * Copyright 2013 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'underscore', 'oae.core'], function($, _, oae) {

    return function(uid, showSettings, widgetData) {

        // The widget container
        var $rootel = $('#' + uid);

        // Requested user's profile
        var userProfile = null;

        // Following/follower information
        var followInfo = {};

        // Basic biography information as array of paragraphs
        var biographyInfo = [];

        // Publications
        var publications = [];

        /**
         * Show the basic user information
         */
        var renderUserInfo = function() {
            // Show user's picture
            oae.api.util.template().render(
                '#academicinfo-profile-picture-template',
                { 'user': userProfile},
                $('.academicinfo-profile-picture', $rootel)
            );

            // Academic identity
            oae.api.util.template().render(
                '#academicinfo-profile-identity-template',
                { 'user': userProfile},
                $('.academicinfo-profile-identity', $rootel)
            );
        };

        /**
         * Show the followers/following information
         */
        var renderFollowInfo = function() {
            oae.api.util.template().render(
                '#academicinfo-profile-follow-info-template',
                {'user': userProfile, 'followInfo': followInfo},
                $('.academicinfo-profile-follow-info', $rootel)
            );
        };

        /**
         * Show the basic biography information
         */
        var renderBiographyInfo = function() {
            _.each(biographyInfo, function(paragraph) {
                var $p = $('<p />').text(paragraph);
                $('.academicinfo-profile-biography', $rootel).append($p);
            })
        };

        /**
         * Show the publication information
         */
        var renderPublicationsInfo = function() {
            var publicationsByYear = _.chain(publications)
                .groupBy('year')
                .sortBy(function(value, key) {
                    return -key;
                })
                .map(function(group) {
                    var yearOfPubs = {};
                    yearOfPubs.year = group[0].year;
                    yearOfPubs.list = group;
                    return yearOfPubs;
                })
                .value()
            oae.api.util.template().render(
                '#academicinfo-publications-template',
                {'publicationsByYear': publicationsByYear},
                $('#academicinfo-publications', $rootel)
            );
        };

        /**
         * Fetch the user profile information
         */
        var getUserInfo = function() {
            oae.api.user.getUser(widgetData.principalId, function(err, data) {
                if (!err) {
                    // Save the user's profile
                    userProfile = data;
                    // Render it
                    renderUserInfo();
                    // And get all the extra info
                    getFollowInfo();
                    getBiographyInfo();
                    getPublicationsInfo();
                }
            });
        }

        /**
         * Fetch the followers/following information
         */
        var getFollowInfo = function() {
            oae.api.follow.getFollowing(widgetData.principalId, function(err, following) {
                if (!err) {
                    followInfo.following = following.results;
                    renderFollowInfo();
                }
            });
            oae.api.follow.getFollowers(widgetData.principalId, function(err, followers) {
                if (!err) {
                    followInfo.followers = followers.results;
                    renderFollowInfo();
                }
            });
        };

        /**
         * Fetch the basic biographical information
         */
        var getBiographyInfo = function() {
            // Stubbed for now
            biographyInfo.push('Daniel Wolpert qualified as a medical doctor in 1989. He joined John Stein\'s group in the Physiology Department of Oxford University where he received his D.Phil. in 1992. He worked as a postdoctoral fellow in the Department of Brain and Cognitive Sciences at MIT in Mike Jordan\'s group. He joined the Sobell Department of Motor Neuroscience, Institute of Neurology as a Lecturer in 1995, and in 2005 moved to the University of Cambridge as Professor of Engineering (1875). He is a fellow of Trinity College.');
            biographyInfo.push('He was elected a Fellow of the Academy of Medical Sciences in 2004 and was awarded the Royal Society Francis Crick Prize Lecture (2005), the Minerva Foundation Golden Brain Award (2010) and gave the Fred Kavli Distinguished International Scientist Lecture at the Society for Neuroscience (2009).');

            renderBiographyInfo();
        };

        /**
         * Fetch the publications information
         */
        var getPublicationsInfo = function() {
            // Stubbed for now
            publications.push({
                year: 2013,
                title: 'Simple Responsive Images With CSS Background Images',
                type: 'Article',
                thumbnail: 'http://www.smashing-media.com/wp-content/uploads/cody-ta-daa.png',
                url: 'http://mobile.smashingmagazine.com/2013/07/22/simple-responsive-images-with-css-backgrounds/',
                source: 'Smashing Magazine',
                status: 'public',
                coauthors: []
            });
            publications.push({
                year: 2013,
                title: 'Unit Testing Backbone.js Applications',
                type: 'Article',
                thumbnail: 'http://snappy-app.com/s/read.php?pass=42787e2a28b26d413639cbd9302bd117',
                url: 'http://www.sitepoint.com/unit-testing-backbone-js-applications/',
                source: 'SitePoint',
                status: 'public',
                coauthors: []
            });
            publications.push({
                year: 2012,
                title: 'Web-Based Visualization Part 1: The D3.js Key Concept',
                type: 'Article',
                thumbnail: 'http://snappy-app.com/s/read.php?pass=e2f47cce7e75b24d8117cd6e0ca350f8',
                url: 'http://ui-cloud.com/web-based-visualization-part-1-the-d3-js-key-concept/',
                source: 'UICloud',
                status: 'public',
                coauthors: []
            });
            publications.push({
                year: 2001,
                title: 'IP Switching and Routing Essentials: Understanding RIP, OSPF, BGP, MPLS, CR-LDP, and RSVP-TE',
                type: 'Book',
                thumbnail: 'http://ecx.images-amazon.com/images/I/51vaIkqMoaL.jpg',
                url: 'http://www.amazon.com/IP-Switching-Routing-Essentials-Understanding/dp/0471034665/ref=la_B000APYM22_1_3?s=books&ie=UTF8&qid=1386595143&sr=1-3',
                source: 'John Wiley & Sons',
                status: 'commercial',
                coauthors: []
            });
            publications.push({
                year: 2001,
                title: 'HTTP Essentials: Protocols for Secure, Scaleable Web Sites',
                type: 'Book',
                thumbnail: 'http://ecx.images-amazon.com/images/I/51-Crc4xksL.jpg',
                url: 'http://www.amazon.com/HTTP-Essentials-Protocols-Secure-Scaleable/dp/0471398233/ref=la_B000APYM22_1_1?s=books&ie=UTF8&qid=1386595253&sr=1-1',
                source: 'John Wiley & Sons',
                status: 'commercial',
                coauthors: []
            });
            publications.push({
                year: 2000,
                title: 'SSL & TLS Essentials: Securing the Web',
                type: 'Book',
                thumbnail: 'http://ecx.images-amazon.com/images/I/51mm45COGmL.jpg',
                url: 'http://www.amazon.com/SSL-TLS-Essentials-Securing-Web/dp/0471383546/ref=la_B000APYM22_1_2?s=books&ie=UTF8&qid=1386595364&sr=1-2',
                source: 'John Wiley & Sons',
                status: 'commercial',
                coauthors: []
            });
            publications.push({
                year: 1997,
                title: 'Building Your Intranet with Windows NT 4.0',
                type: 'Book',
                thumbnail: 'http://ecx.images-amazon.com/images/I/51vS9A0SNoL.jpg',
                url: 'http://www.amazon.com/Building-Your-Intranet-Windows-4-0-ebook/dp/B0014TQIQ6/ref=la_B000APYM22_1_5?s=books&ie=UTF8&qid=1386595474&sr=1-5',
                source: 'John Wiley & Sons',
                status: 'commercial',
                coauthors: [
                    { name: 'Sue Plumley', url: 'http://www.amazon.com/s/ref=ntt_athr_dp_sr_2?_encoding=UTF8&field-author=Sue%20Plumley&search-alias=books&sort=relevancerank' }
                ]
            });
            publications.push({
                year: 1996,
                title: 'IPng and the TCP/IP Protocols: Implementing the Next Generation Internet',
                type: 'Book',
                thumbnail: 'http://ecx.images-amazon.com/images/I/51V1HAETCBL.jpg',
                url: 'http://www.amazon.com/IPng-TCP-Protocols-Implementing-Generation/dp/0471130885/ref=la_B000APYM22_1_4?s=books&ie=UTF8&qid=1386595651&sr=1-4',
                source: 'John Wiley & Sons',
                status: 'commercial',
                coauthors: []
            });

            renderPublicationsInfo();
        };

        /**
         * Set event bindings
         */
        var addBinding = function() {
            $(document).on('click', '#' + uid + ' .academicinfo-profile-follow', function() {
                oae.api.follow.follow(widgetData.principalId, function(err) {
                    if (!err) {
                        // Show a success notification
                        oae.api.util.notification(
                            oae.api.i18n.translate('__MSG__FOLLOWING_SUCCEEDED__'),
                            oae.api.i18n.translate('__MSG__FOLLOWING_YOU_ARE_NOW_FOLLOWING__', null, {
                                'displayName': userProfile.displayName
                            })
                        );
                        getFollowInfo();
                    } else {
                        // Show an error notification
                        oae.api.util.notification(
                            oae.api.i18n.translate('__MSG__FOLLOWING_FAILED__'),
                            oae.api.i18n.translate('__MSG__FOLLOWING_COULD_NOT_FOLLOW__', null, {
                                'displayName': userProfile.displayName
                            }),
                            'error'
                        );
                    }
                });
            });
        };

        addBinding();
        getUserInfo();
    };
});