/*!
 * Copyright 2013 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'underscore', 'oae.core'], function($, _, oae) {

    return function(uid, showSettings, widgetData) {

        // The widget container
        var $rootel = $('#' + uid);

        // Requested user's profile
        var userProfile = null;

        // Following/follower information
        var followInfo = {};

        /**
         * Show the basic user information
         */
        var renderUserInfo = function() {
            // Show user's picture
            oae.api.util.template().render(
                '#academicinfo-profile-picture-template',
                { 'user': userProfile},
                $('.academicinfo-profile-picture', $rootel)
            );

            // Academic identity
            oae.api.util.template().render(
                '#academicinfo-profile-identity-template',
                { 'user': userProfile},
                $('.academicinfo-profile-identity', $rootel)
            );

            // Stubbed static content
            $('.academicinfo-profile-description', $rootel).append("<p>Daniel Wolpert qualified as a medical doctor in 1989. He joined John Stein\'s group in the Physiology Department of Oxford University where he received his D.Phil. in 1992. He worked as a postdoctoral fellow in the Department of Brain and Cognitive Sciences at MIT in Mike Jordan's group. He joined the Sobell Department of Motor Neuroscience, Institute of Neurology as a Lecturer in 1995, and in 2005 moved to the University of Cambridge as Professor of Engineering (1875). He is a fellow of Trinity College.</p><p>He was elected a Fellow of the Academy of Medical Sciences in 2004 and was awarded the Royal Society Francis Crick Prize Lecture (2005), the Minerva Foundation Golden Brain Award (2010) and gave the Fred Kavli Distinguished International Scientist Lecture at the Society for Neuroscience (2009).</p>");

        };

        /**
         * Show the followers/following information
         */
        var renderFollowInfo = function() {
            oae.api.util.template().render(
                '#academicinfo-profile-follow-info-template',
                {'user': userProfile, 'followInfo': followInfo},
                $('.academicinfo-profile-follow-info', $rootel)
            );
        };

        /**
         * Fetch the user profile information
         */
        var getUserInfo = function() {
            oae.api.user.getUser(widgetData.principalId, function(err, data) {
                if (!err) {
                    // Save the user's profile
                    userProfile = data;
                    // Render it
                    renderUserInfo();
                    // And get followers/following info
                    getFollowInfo();
                }
            });
        }

        /**
         * Fetch the followers/following information
         */
        var getFollowInfo = function() {
            oae.api.follow.getFollowing(widgetData.principalId, function(err, following) {
                if (!err) {
                    followInfo.following = following.results;
                    clearFollowBindings();
                    renderFollowInfo();
                    setFollowBindings();
                }
            });
            oae.api.follow.getFollowers(widgetData.principalId, function(err, followers) {
                if (!err) {
                    followInfo.followers = followers.results;
                    clearFollowBindings();
                    renderFollowInfo();
                    setFollowBindings();
                }
            });
        };

        /**
         * Set event bindings for following
         */
        var setFollowBindings = function() {
            $('.academicinfo-profile-follow', $rootel).on('click', function() {
                oae.api.follow.follow(widgetData.principalId, function(err) {
                    if (!err) {
                        // Show a success notification
                        oae.api.util.notification(
                            oae.api.i18n.translate('__MSG__FOLLOWING_SUCCEEDED__'),
                            oae.api.i18n.translate('__MSG__FOLLOWING_YOU_ARE_NOW_FOLLOWING__', null, {
                                'displayName': userProfile.displayName
                            })
                        );
                        getFollowInfo();
                    } else {
                        // Show an error notification
                        oae.api.util.notification(
                            oae.api.i18n.translate('__MSG__FOLLOWING_FAILED__'),
                            oae.api.i18n.translate('__MSG__FOLLOWING_COULD_NOT_FOLLOW__', null, {
                                'displayName': userProfile.displayName
                            }),
                            'error'
                        );
                    }
                });
            });
        };

        /**
         * Clear event bindings for following
         */
        var clearFollowBindings = function() {
            $('.academicinfo-profile-follow', $rootel).off('click');
        }

        getUserInfo();
    };
});
